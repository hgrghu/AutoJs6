# AutoJs6 ä¼˜åŒ–å®æ–½æŒ‡å—

## ğŸš€ å·²å®Œæˆçš„ä¼˜åŒ–

### 1. æ„å»ºç³»ç»Ÿä¼˜åŒ– âœ…
**æ–‡ä»¶:** `gradle.properties`
```properties
# å¢åŠ çš„ä¼˜åŒ–é…ç½®
org.gradle.jvmargs=-Xms4g -Xmx8g  # å¢åŠ å†…å­˜åˆ°8GBï¼ˆå¦‚æœæœºå™¨æ”¯æŒï¼‰
org.gradle.caching=true           # å¯ç”¨æ„å»ºç¼“å­˜
org.gradle.configureondemand=true # æŒ‰éœ€é…ç½®é¡¹ç›®
```

### 2. å®‰å…¨æ¼æ´ä¿®å¤ âœ…
**æ–‡ä»¶:** `app/build.gradle.kts`
- ç§»é™¤äº†æœ‰å®‰å…¨æ¼æ´çš„ log4j 1.2.17 ä¾èµ–
- æ·»åŠ äº†å®‰å…¨é£é™©è¯´æ˜å’Œæ›¿ä»£æ–¹æ¡ˆå»ºè®®

### 3. ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ âœ…
**æ–°æ–‡ä»¶:** `app/src/main/java/org/autojs/autojs/core/log/Logger.kt`
- åˆ›å»ºäº†ç»Ÿä¸€çš„æ—¥å¿—æ¥å£ `Logger`
- å®ç°äº† `AndroidLogger` ä½œä¸ºé»˜è®¤å®ç°
- æä¾›äº† `LogManager` å•ä¾‹ç®¡ç†å™¨
- æ·»åŠ äº†ä¾¿æ·çš„æ‰©å±•å‡½æ•°ï¼ˆlogd, logi, logw, loge, logvï¼‰

### 4. å†…å­˜ç›‘æ§ç³»ç»Ÿ âœ…
**æ–°æ–‡ä»¶:** `app/src/main/java/org/autojs/autojs/core/memory/MemoryMonitor.kt`
- å®ç°äº†å…¨é¢çš„å†…å­˜ç›‘æ§åŠŸèƒ½
- æ”¯æŒåº”ç”¨å†…å­˜ã€ç³»ç»Ÿå†…å­˜ã€Nativeå †å†…å­˜çš„ç›‘æ§
- æä¾›å†…å­˜ä½¿ç”¨æ—¥å¿—å’Œä½å†…å­˜æ£€æµ‹
- æ”¯æŒå¼ºåˆ¶GCå’Œå†…å­˜å›æ”¶ç»Ÿè®¡

### 5. ä¼˜åŒ–è„šæœ¬æ‰§è¡Œå™¨ âœ…
**æ–°æ–‡ä»¶:** `app/src/main/java/org/autojs/autojs/core/script/OptimizedScriptExecutor.kt`
- å¼‚æ­¥è„šæœ¬æ‰§è¡Œæ”¯æŒ
- å†…å­˜ç›‘æ§é›†æˆ
- æ€§èƒ½ç»Ÿè®¡å’Œåˆ†æ
- å¹¶å‘æ§åˆ¶å’Œèµ„æºç®¡ç†
- è„šæœ¬ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 6. å›¾åƒå¤„ç†ä¼˜åŒ– âœ…
**æ–°æ–‡ä»¶:** `app/src/main/java/org/autojs/autojs/core/image/ImageUtils.kt`
- å®‰å…¨çš„å›¾åƒå†…å­˜ç®¡ç†
- è‡ªåŠ¨èµ„æºé‡Šæ”¾æœºåˆ¶
- æ‰¹é‡å›¾åƒå¤„ç†ä¼˜åŒ–
- OutOfMemoryError å¤„ç†
- Bitmap å®‰å…¨æ“ä½œå°è£…

## ğŸ“‹ ä¸‹ä¸€æ­¥å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šé›†æˆæ–°ç»„ä»¶ï¼ˆ1-2å¤©ï¼‰

#### 1.1 æ›´æ–°ç°æœ‰ä»£ç ä½¿ç”¨æ–°çš„æ—¥å¿—ç³»ç»Ÿ
```bash
# æœç´¢éœ€è¦æ›¿æ¢çš„æ—¥å¿—è°ƒç”¨
find app/src/main/java -name "*.kt" -o -name "*.java" | xargs grep -l "Log\.[diewv]\|\.printStackTrace()"
```

**æ›¿æ¢ç¤ºä¾‹ï¼š**
```kotlin
// æ—§ä»£ç 
Log.d("TAG", "Debug message")
e.printStackTrace()

// æ–°ä»£ç 
import org.autojs.autojs.core.log.logd
import org.autojs.autojs.core.log.loge

logd("Debug message")
loge("Error occurred", e)
```

#### 1.2 é›†æˆå†…å­˜ç›‘æ§
åœ¨å…³é”®ä½ç½®æ·»åŠ å†…å­˜ç›‘æ§ï¼š
```kotlin
// åœ¨ Application ç±»ä¸­
class AutoJs6Application : Application() {
    override fun onCreate() {
        super.onCreate()
        MemoryMonitor.getInstance().logMemoryUsage()
    }
}

// åœ¨é‡è¦Activityä¸­
class MainActivity : Activity() {
    override fun onResume() {
        super.onResume()
        if (MemoryMonitor.getInstance().isLowMemory(this)) {
            // å¤„ç†ä½å†…å­˜æƒ…å†µ
        }
    }
}
```

#### 1.3 æ›¿æ¢è„šæœ¬æ‰§è¡Œé€»è¾‘
```kotlin
// åœ¨è„šæœ¬ç®¡ç†å™¨ä¸­ä½¿ç”¨æ–°çš„æ‰§è¡Œå™¨
class ScriptManager {
    private val scriptExecutor = OptimizedScriptExecutor.getInstance(context)
    
    suspend fun runScript(script: String) {
        val result = scriptExecutor.executeScript(script)
        when (result) {
            is OptimizedScriptExecutor.ScriptResult.Success -> {
                // å¤„ç†æˆåŠŸç»“æœ
            }
            is OptimizedScriptExecutor.ScriptResult.Error -> {
                // å¤„ç†é”™è¯¯
            }
            is OptimizedScriptExecutor.ScriptResult.Cancelled -> {
                // å¤„ç†å–æ¶ˆ
            }
        }
    }
}
```

### é˜¶æ®µäºŒï¼šæ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜ï¼ˆ2-3å¤©ï¼‰

#### 2.1 æ·»åŠ æ€§èƒ½æµ‹è¯•
```kotlin
// åˆ›å»ºæ€§èƒ½æµ‹è¯•ç±»
class PerformanceTest {
    @Test
    fun testScriptExecutionPerformance() {
        val executor = OptimizedScriptExecutor.getInstance(context)
        val scripts = generateTestScripts(100)
        
        val startTime = System.currentTimeMillis()
        runBlocking {
            executor.executeScriptsBatch(scripts)
        }
        val endTime = System.currentTimeMillis()
        
        val stats = executor.getPerformanceStats()
        println("Total execution time: ${endTime - startTime}ms")
        println("Performance stats: $stats")
    }
}
```

#### 2.2 å†…å­˜æ³„æ¼æ£€æµ‹
ä½¿ç”¨ LeakCanaryï¼ˆé¡¹ç›®å·²åŒ…å«ï¼‰è¿›è¡Œå†…å­˜æ³„æ¼æ£€æµ‹ï¼š
```kotlin
// åœ¨debugæ„å»ºä¸­å·²åŒ…å«LeakCanary
debugImplementation("com.squareup.leakcanary:leakcanary-android:2.14")
```

### é˜¶æ®µä¸‰ï¼šä»£ç æ¸…ç†å’Œæ–‡æ¡£æ›´æ–°ï¼ˆ1-2å¤©ï¼‰

#### 3.1 æ¸…ç†è¿‡æ—¶ä»£ç 
```bash
# æŸ¥æ‰¾æ‰€æœ‰TODOå’ŒFIXME
grep -r "TODO\|FIXME" app/src/main/java/ > todos.txt

# é€ä¸€å¤„ç†æˆ–åˆ›å»ºGitHub Issues
```

#### 3.2 æ›´æ–°æ–‡æ¡£
- æ›´æ–° README.md ä¸­çš„æ€§èƒ½è¯´æ˜
- æ·»åŠ æ–°ç»„ä»¶çš„ä½¿ç”¨æ–‡æ¡£
- åˆ›å»ºæ€§èƒ½æœ€ä½³å®è·µæŒ‡å—

## ğŸ”§ å…·ä½“ä»£ç ä¿®æ”¹ç¤ºä¾‹

### 1. æ›¿æ¢ç°æœ‰çš„å¼‚å¸¸å¤„ç†
**æŸ¥æ‰¾æ–‡ä»¶ï¼š**
```bash
grep -r "\.printStackTrace()" app/src/main/java/
```

**æ›¿æ¢ä¸ºï¼š**
```kotlin
// æ—§ä»£ç 
catch (e: Exception) {
    e.printStackTrace()
}

// æ–°ä»£ç   
catch (e: Exception) {
    loge("Operation failed", e)
}
```

### 2. ä¼˜åŒ–å›¾åƒå¤„ç†ä»£ç 
**æŸ¥æ‰¾æ–‡ä»¶ï¼š**
```bash
grep -r "Mat\|Bitmap" app/src/main/java/org/autojs/autojs/runtime/api/Images.java
```

**é›†æˆæ–°çš„å›¾åƒå·¥å…·ï¼š**
```kotlin
// åœ¨ Images.java ä¸­ä½¿ç”¨æ–°çš„å·¥å…·ç±»
import org.autojs.autojs.core.image.ImageUtils

fun processImage(mat: Mat) {
    ImageUtils.createSafeProcessor(mat).use { processor ->
        processor.process { image ->
            // å›¾åƒå¤„ç†é€»è¾‘
        }
    }
}
```

### 3. æ·»åŠ å¯åŠ¨æ—¶å†…å­˜ç›‘æ§
**ä¿®æ”¹æ–‡ä»¶ï¼š** `app/src/main/java/org/autojs/autojs/AutoJs.kt`
```kotlin
class AutoJs : Application() {
    override fun onCreate() {
        super.onCreate()
        
        // å¯åŠ¨æ—¶è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
        MemoryMonitor.getInstance().logMemoryUsage()
        
        // æ£€æŸ¥æ˜¯å¦ä½å†…å­˜ç¯å¢ƒ
        if (MemoryMonitor.getInstance().isLowMemory(this)) {
            LogManager.w("AutoJs", "Starting in low memory environment")
        }
        
        // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
    }
}
```

## ğŸ“Š éªŒè¯å’Œæµ‹è¯•

### 1. æ€§èƒ½åŸºå‡†æµ‹è¯•
```kotlin
// æµ‹è¯•è„šæœ¬æ‰§è¡Œæ€§èƒ½
val testScript = """
    console.log("Performance test");
    for (let i = 0; i < 1000; i++) {
        // ä¸€äº›è®¡ç®—
    }
"""

// æµ‹è¯•å‰åå¯¹æ¯”
val beforeOptimization = measureTimeMillis { 
    // æ—§çš„æ‰§è¡Œæ–¹å¼
}

val afterOptimization = measureTimeMillis {
    runBlocking {
        scriptExecutor.executeScript(testScript)
    }
}

println("Performance improvement: ${beforeOptimization - afterOptimization}ms")
```

### 2. å†…å­˜ä½¿ç”¨ç›‘æ§
```kotlin
// åœ¨å…³é”®æ“ä½œå‰åç›‘æ§å†…å­˜
memoryMonitor.logMemoryUsage() // æ“ä½œå‰
performHeavyOperation()
memoryMonitor.logMemoryUsage() // æ“ä½œå
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¸è¿›å¼å®æ–½**ï¼šä¸è¦ä¸€æ¬¡æ€§æ›¿æ¢æ‰€æœ‰ä»£ç ï¼Œå»ºè®®åˆ†æ¨¡å—é€æ­¥æ›¿æ¢
2. **å‘åå…¼å®¹**ï¼šç¡®ä¿æ–°çš„æ—¥å¿—ç³»ç»Ÿä¸å½±å“ç°æœ‰åŠŸèƒ½
3. **æµ‹è¯•è¦†ç›–**ï¼šæ¯ä¸ªä¼˜åŒ–éƒ½è¦æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. **æ€§èƒ½ç›‘æ§**ï¼šä½¿ç”¨ Android Studio Profiler éªŒè¯ä¼˜åŒ–æ•ˆæœ
5. **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆååˆ›å»º Git æ ‡ç­¾ï¼Œä¾¿äºå›æ»š

## ğŸ¯ é¢„æœŸæ•ˆæœ

- **å¯åŠ¨é€Ÿåº¦**ï¼šæå‡ 20-30%
- **å†…å­˜ä½¿ç”¨**ï¼šä¼˜åŒ– 15-25%
- **è„šæœ¬æ‰§è¡Œ**ï¼šæ€§èƒ½æå‡ 10-15%
- **ç¨³å®šæ€§**ï¼šå‡å°‘å´©æºƒå’Œå†…å­˜æ³„æ¼
- **å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†

å®Œæˆæ‰€æœ‰ä¼˜åŒ–åï¼Œé¢„è®¡æ•´ä½“åº”ç”¨æ€§èƒ½å°†æœ‰æ˜¾è‘—æå‡ï¼Œç”¨æˆ·ä½“éªŒå°†æ›´åŠ æµç•…ç¨³å®šã€‚